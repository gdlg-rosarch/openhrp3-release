From aeec085a2f403a0401d8d0cb1d1a05f7d5e8fda4 Mon Sep 17 00:00:00 2001
From: Kei Okada <kei.okada@gmail.com>
Date: Wed, 18 Mar 2015 10:03:01 +0900
Subject: [PATCH 5/5] [BodyInfoCollada_impl.cpp] fix for wrong collada
 interpretation, joint axis is in child frame

---
 server/ModelLoader/BodyInfoCollada_impl.cpp | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/server/ModelLoader/BodyInfoCollada_impl.cpp b/server/ModelLoader/BodyInfoCollada_impl.cpp
index 2e4fd5d..c87aa06 100644
--- a/server/ModelLoader/BodyInfoCollada_impl.cpp
+++ b/server/ModelLoader/BodyInfoCollada_impl.cpp
@@ -1014,12 +1014,17 @@ class ColladaReader : public daeErrorHandler
                 }
                 if( len2 > 0 ) {
                     len2 = 1/len2;
+                    DblArray12  trans_joint_to_child;
+                    _ExtractFullTransform(trans_joint_to_child, pattfull->getLink());
+                    DblArray12 patt;
+                    PoseInverse(patt, trans_joint_to_child);
+                    len2 = 1/len2;
                     double ax = pdomaxis->getAxis()->getValue()[0]*len2;
                     double ay = pdomaxis->getAxis()->getValue()[1]*len2;
                     double az = pdomaxis->getAxis()->getValue()[2]*len2;
-                    pjoint->jointAxis[0] = tatt[0] * ax + tatt[1] * ay + tatt[2] * az;
-                    pjoint->jointAxis[1] = tatt[4] * ax + tatt[5] * ay + tatt[6] * az;
-                    pjoint->jointAxis[2] = tatt[8] * ax + tatt[9] * ay + tatt[10] * az;
+                    pjoint->jointAxis[0] = patt[0] * ax + patt[1] * ay + patt[2] * az;
+                    pjoint->jointAxis[1] = patt[4] * ax + patt[5] * ay + patt[6] * az;
+                    pjoint->jointAxis[2] = patt[8] * ax + patt[9] * ay + patt[10] * az;
                     COLLADALOG_DEBUG(str(boost::format("axis: %f %f %f -> %f %f %f")%ax%ay%az%pjoint->jointAxis[0]%pjoint->jointAxis[1]%pjoint->jointAxis[2]));
                 }
                 else {
-- 
1.9.1

